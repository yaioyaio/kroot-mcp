#!/usr/bin/env node

/**
 * AIMonitor ë§¤ë‰´ì–¼ í…ŒìŠ¤íŠ¸
 * 
 * ì‹¤í–‰ ë°©ë²•:
 * node tests/manual/test-ai-monitor.js
 */

import { AIMonitor } from '../../dist/analyzers/ai-monitor.js';
import { EventEngine } from '../../dist/events/engine.js';
import { EventCategory, EventSeverity } from '../../dist/events/types/base.js';
import { FileChangeAction } from '../../dist/events/types/file.js';
import { GitEventType } from '../../dist/events/types/git.js';

console.log('=== AIMonitor í…ŒìŠ¤íŠ¸ ì‹œì‘ ===\n');

// EventEngine ì´ˆê¸°í™”
const eventEngine = new EventEngine();
const aiMonitor = new AIMonitor();

// ì´ë²¤íŠ¸ë¥¼ ë¶„ì„ê¸°ì— ì—°ê²°
eventEngine.subscribe('*', async (event) => {
  await aiMonitor.analyzeEvent(event);
});

// AI ì‚¬ìš© ê°ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
aiMonitor.on('aiUsageDetected', (detection) => {
  console.log(`\nğŸ¤– AI ì‚¬ìš© ê°ì§€: ${detection.tool}`);
  console.log(`   ìœ í˜•: ${detection.usageType}`);
  console.log(`   ì‹ ë¢°ë„: ${(detection.confidence * 100).toFixed(1)}%`);
  console.log(`   ì»¨í…ìŠ¤íŠ¸: ${detection.context}`);
});

aiMonitor.on('suggestionTracked', (suggestion) => {
  console.log(`\nğŸ’¡ ì œì•ˆ ì¶”ì : ${suggestion.tool}`);
  console.log(`   íŒŒì¼: ${suggestion.filePath}`);
  console.log(`   ìƒíƒœ: ${suggestion.status}`);
  console.log(`   ìˆ˜ì • ë¹„ìœ¨: ${(suggestion.modificationRatio * 100).toFixed(1)}%`);
});

aiMonitor.on('sessionStarted', (session) => {
  console.log(`\nğŸš€ ì„¸ì…˜ ì‹œì‘: ${session.tool}`);
  console.log(`   ID: ${session.id}`);
});

aiMonitor.on('metricsUpdated', (metrics) => {
  console.log(`\nğŸ“Š ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸: ${metrics.tool}`);
  console.log(`   ìˆ˜ë½ë¥ : ${(metrics.acceptanceRate * 100).toFixed(1)}%`);
  console.log(`   ì´ ìƒí˜¸ì‘ìš©: ${metrics.totalInteractions}`);
  console.log(`   ì‹œê°„ ì ˆì•½: ${metrics.timesSaved}ë¶„`);
});

// í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
function createClaudeFileEvent() {
  return {
    id: Math.random().toString(),
    timestamp: Date.now(),
    category: EventCategory.FILE,
    type: 'file:modified',
    severity: EventSeverity.INFO,
    source: 'test',
    data: {
      action: FileChangeAction.CHANGE,
      newFile: {
        path: '/src/components/UserProfile.tsx',
        content: `
// Generated by Claude AI
import React from 'react';

interface UserProfileProps {
  userId: string;
  name: string;
  email: string;
}

export const UserProfile: React.FC<UserProfileProps> = ({ userId, name, email }) => {
  return (
    <div className="user-profile">
      <h2>{name}</h2>
      <p>Email: {email}</p>
      <p>ID: {userId}</p>
    </div>
  );
};

// Claude suggested adding error handling here
`,
        stats: { size: 500, modified: Date.now() }
      },
      oldFile: {
        path: '/src/components/UserProfile.tsx',
        content: `
import React from 'react';

export const UserProfile = ({ userId, name, email }) => {
  return (
    <div>
      <h2>{name}</h2>
      <p>{email}</p>
    </div>
  );
};
`,
        stats: { size: 200, modified: Date.now() - 3600000 }
      }
    }
  };
}

function createCopilotFileEvent() {
  return {
    id: Math.random().toString(),
    timestamp: Date.now(),
    category: EventCategory.FILE,
    type: 'file:created',
    severity: EventSeverity.INFO,
    source: 'test',
    data: {
      action: FileChangeAction.ADD,
      newFile: {
        path: '/tests/user.test.ts',
        content: `
// Copilot generated test
describe('User', () => {
  it('should create a new user', () => {
    // Copilot suggestion
    const user = new User('John', 'john@example.com');
    expect(user.name).toBe('John');
    expect(user.email).toBe('john@example.com');
  });

  it('should validate email format', () => {
    // GitHub Copilot helped with this test
    expect(() => new User('John', 'invalid-email')).toThrow();
  });
});
`,
        stats: { size: 400, modified: Date.now() }
      }
    }
  };
}

function createChatGPTCommitEvent() {
  return {
    id: Math.random().toString(),
    timestamp: Date.now(),
    category: EventCategory.GIT,
    type: 'git:commit',
    severity: EventSeverity.INFO,
    source: 'test',
    data: {
      action: 'commit',
      repository: 'test-repo',
      branch: 'feature/ai-integration',
      commit: 'def456',
      author: 'Test User',
      message: 'feat: implement user authentication using ChatGPT suggestions',
      stats: {
        additions: 50,
        deletions: 10,
        files: 3
      }
    }
  };
}

function createCursorFileEvent() {
  return {
    id: Math.random().toString(),
    timestamp: Date.now(),
    category: EventCategory.FILE,
    type: 'file:modified',
    severity: EventSeverity.INFO,
    source: 'test',
    data: {
      action: FileChangeAction.CHANGE,
      newFile: {
        path: '/.cursor/settings.json',
        content: '{"ai_enabled": true, "model": "gpt-4"}',
        stats: { size: 50, modified: Date.now() }
      }
    }
  };
}

function createProcessEvent(processName) {
  return {
    id: Math.random().toString(),
    timestamp: Date.now(),
    category: EventCategory.PROCESS,
    type: 'process:started',
    severity: EventSeverity.INFO,
    source: 'test',
    data: {
      name: processName,
      pid: Math.floor(Math.random() * 10000),
      command: processName
    }
  };
}

// í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
async function runTestScenario() {
  console.log('\n=== ì‹œë‚˜ë¦¬ì˜¤ 1: Claude ì‚¬ìš© ê°ì§€ ===');
  eventEngine.emit(createProcessEvent('claude'));
  await new Promise(resolve => setTimeout(resolve, 100));
  eventEngine.emit(createClaudeFileEvent());
  await new Promise(resolve => setTimeout(resolve, 500));

  console.log('\n=== ì‹œë‚˜ë¦¬ì˜¤ 2: GitHub Copilot ì‚¬ìš© ê°ì§€ ===');
  eventEngine.emit(createProcessEvent('copilot'));
  await new Promise(resolve => setTimeout(resolve, 100));
  eventEngine.emit(createCopilotFileEvent());
  await new Promise(resolve => setTimeout(resolve, 500));

  console.log('\n=== ì‹œë‚˜ë¦¬ì˜¤ 3: ChatGPT ì»¤ë°‹ ê°ì§€ ===');
  eventEngine.emit(createChatGPTCommitEvent());
  await new Promise(resolve => setTimeout(resolve, 500));

  console.log('\n=== ì‹œë‚˜ë¦¬ì˜¤ 4: Cursor ì‚¬ìš© ê°ì§€ ===');
  eventEngine.emit(createCursorFileEvent());
  await new Promise(resolve => setTimeout(resolve, 500));

  // ìµœì¢… ë¶„ì„ ê²°ê³¼ ì¶œë ¥
  console.log('\n=== ìµœì¢… AI í˜‘ì—… ë¶„ì„ ===');
  const analysis = aiMonitor.analyze();
  
  console.log(`\nì „ì²´ AI ê¸°ì—¬ë„: ${(analysis.overallMetrics.aiContributionRatio * 100).toFixed(1)}%`);
  console.log(`ìƒì‚°ì„± í–¥ìƒ: ${analysis.overallMetrics.productivityGain.toFixed(1)}%`);
  console.log(`ì´ AI ì§€ì› ì‹œê°„: ${analysis.overallMetrics.totalAIAssistedTime}ë¶„`);
  
  console.log('\në„êµ¬ë³„ ë¶„ì„:');
  for (const [tool, data] of Object.entries(analysis.tools)) {
    if (data) {
      console.log(`\n${tool}:`);
      console.log(`  ì„¸ì…˜: ${data.sessions}`);
      console.log(`  ìƒí˜¸ì‘ìš©: ${data.interactions}`);
      console.log(`  ìˆ˜ë½ë¥ : ${(data.acceptanceRate * 100).toFixed(1)}%`);
      console.log(`  ì‹œê°„ ì ˆì•½: ${data.timesSaved}ë¶„`);
    }
  }

  console.log('\nì¸ì‚¬ì´íŠ¸:');
  console.log(`  ê°€ì¥ íš¨ê³¼ì ì¸ ë„êµ¬: ${analysis.insights.mostEffectiveTool}`);
  console.log(`  ìµœì  ì‚¬ìš© ì‚¬ë¡€: ${analysis.insights.bestUseCases.join(', ')}`);
  
  if (analysis.insights.recommendations.length > 0) {
    console.log('\nê¶Œì¥ì‚¬í•­:');
    analysis.insights.recommendations.forEach((rec, idx) => {
      console.log(`  ${idx + 1}. ${rec}`);
    });
  }

  // ì‚¬ìš© íŒ¨í„´ ë¶„ì„
  console.log('\n=== ì‚¬ìš© íŒ¨í„´ ë¶„ì„ ===');
  const patterns = aiMonitor.analyzeUsagePatterns();
  patterns.forEach((pattern, tool) => {
    console.log(`\n${tool} íŒ¨í„´:`);
    console.log(`  ì£¼ìš” ì‚¬ìš© ìœ í˜•: ${pattern.patterns.mostUsedTypes.join(', ')}`);
    console.log(`  í”¼í¬ ì‹œê°„: ${pattern.patterns.peakHours.join(', ')}ì‹œ`);
    console.log(`  í‰ê·  ì„¸ì…˜ ì‹œê°„: ${pattern.patterns.averageSessionDuration}ë¶„`);
    console.log(`  ì‹œê°„ë‹¹ ìƒì„± ë¼ì¸: ${pattern.productivity.linesGeneratedPerHour}`);
  });
}

// í…ŒìŠ¤íŠ¸ ì‹¤í–‰
runTestScenario().then(() => {
  console.log('\n=== AIMonitor í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
  process.exit(0);
}).catch(error => {
  console.error('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
  process.exit(1);
});